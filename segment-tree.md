# âœ´ï¸ğŸŒŸæ‰‹å†™çº¿æ®µæ ‘æŒ‡å—ğŸŒŸâ­ WedJul17 2024
> [çº¿æ®µæ ‘](https://oi-wiki.org/ds/seg)æ˜¯ç®—æ³•ç«èµ›ä¸­å¸¸ç”¨çš„ç”¨æ¥ç»´æŠ¤**åŒºé—´ä¿¡æ¯**çš„æ•°æ®ç»“æ„.

ä½†æ˜¯æˆ‘è®¤ä¸ºå‡ ä¹æ‰€æœ‰æ¶‰åŠåŒºé—´åˆ†æ²»çš„é—®é¢˜éƒ½èƒ½æ‹¿çº¿æ®µæ ‘åš. çº¿æ®µæ ‘å°±åƒæ˜¯ä¿å­˜äº†åˆ†æ²»æ—¶æ¯ä¸ªå­é—®é¢˜çš„ç­”æ¡ˆ, å½“æ•°æ®è¢«ä¿®æ”¹æ—¶é‡æ–°è®¡ç®—å˜åŒ–çš„é‚£ä¸ªå­é—®é¢˜å³å¯. å½“æ¶‰åŠå¤§è§„æ¨¡çš„ä¿®æ”¹æ—¶, è¿˜èƒ½å¼•å…¥æ‡’æƒ°æ ‡è®°(lazytag)æ¥æ‰¹é‡æ ‡è®°ä¿®æ”¹.
> ~~æˆ‘ä»¬å®¶çº¿æ®µæ ‘çœŸçš„æ˜¯å¤ªå¥½ç”¨å•¦~~.

åœ¨è¿™ä¸ªæ–‡æ¡£é‡Œæˆ‘ä¼šè®°å½•åˆšå¼€å§‹å†™çº¿æ®µæ ‘æ—¶çŠ¯è¿‡çš„é”™è¯¯~~å¹¶ä¸”è®©ä½ /æ‚¨ä¹ŸçŠ¯ä¸€æ¬¡~~. å°½ç®¡è¿™é‡Œä»£ç æ•°ç»„ä¸‹æ ‡å’Œå¤§éƒ¨åˆ†äººçš„ä¹ æƒ¯ä¸åŒ, æˆ‘è¿˜æ˜¯å¸Œæœ›è¯»è€…çœ‹å®Œåèƒ½ç†Ÿæ‚‰çº¿æ®µæ ‘çš„æµç¨‹, ä»¥åŠé‚£äº›å‡½æ•°æ€ä¹ˆæ¥çš„.
> å½“ä½ ä¼šå†™çº¿æ®µæ ‘å, ä½ ä¼šè§‰å¾—â€œçº¿æ®µæ ‘å°±è¯¥è¿™ä¹ˆå†™â€.

## åªèƒ½åŒºé—´åŠ çš„çº¿æ®µæ ‘
çº¿æ®µæ ‘æ€æƒ³å¾ˆæœ´ç´ , ~~å®ç°èµ·æ¥ä¹Ÿç®€å•~~?
> [Luogu P3372](https://www.luogu.com.cn/problem/P3372) çº¿æ®µæ ‘ I <br/>
> ç»´æŠ¤ä¸€ä¸ªåºåˆ—, å…è®¸åŒºé—´åŠ ã€æ±‚åŒºé—´å’Œ. æ“ä½œæ•°å’Œåºåˆ—é•¿åº¦ä¸è¶…è¿‡ `1e5`.

çº¿æ®µæ ‘æ˜¯äºŒå‰æ ‘, å¯ä»¥æŠŠå®ƒå»ºåœ¨æ•°ç»„ä¸Š. å¯¹äºèŠ‚ç‚¹ $u$, ç”¨ $2u+1$ å’Œ $2u+2$ è¡¨ç¤ºå·¦å³å­ç»“ç‚¹. çº¿æ®µæ ‘è¿˜è¦æœ‰æ‡’æƒ°æ ‡è®°, æ‰€ä»¥æˆ‘ä»¬æ¥ä¸¤ä¸ªæ•°ç»„:
```cpp
const int N=1e5+5;  // å¤§å°è®°å¾—å¼€ 4N ä¸ç„¶è¯…å’’ä½  RE!
ll sum[N*4];  // è¿™ä¸ªèŠ‚ç‚¹å¯¹åº”åŒºé—´çš„çœŸå®åŒºé—´å’Œ
ll tag[N*4];  // è¡¨ç¤ºè¿™ä¸ªèŠ‚ç‚¹å­æ ‘æ¯ä¸ªå¶å­å°†è¦åŠ ä¸Šçš„å€¼
// æ‡’æƒ°æ ‡è®°ä¸èƒ½å¤ªæ‡’æƒ° è¦ä¿è¯è®¿é—®åˆ°èŠ‚ç‚¹æ—¶ sum ä¸€å®šè¦å‡†ç¡®!
```

çº¿æ®µæ ‘ä¸æ˜¯æ ‘å—? é‚£æˆ‘ä»¬æ¥å»ºä¸ªæ ‘:
```cpp
void init();  // æœ‰äººä¼šå†™æˆ build
```

è¿™é‡Œçº¿æ®µæ ‘è¦æœ‰ä¸¤ä¸ªåŠŸèƒ½, ä¸€ä¸ªæ˜¯åŒºé—´åŠ ï¼Œä¸€ä¸ªæ˜¯åŒºé—´å’Œï¼Œé‚£ä¹ˆå½“ç„¶è¦ä¸¤ä¸ªå‡½æ•°:
```cpp
// [lf, rg) æ˜¯ä¿®æ”¹åŒºé—´, k æ˜¯åŒºé—´è¦åŠ ä¸Šçš„æ•°å­—
void range_add(int lf, int rg, ll k);
ll get_sum(int lf, int rg);
```
ç„¶åæ¥æƒ³æƒ³å‡½æ•°æ€ä¹ˆå†™â€¦â€¦é¦–å…ˆæ˜¯å»ºæ ‘ï¼Œè‚¯å®šè¦é€’å½’å»ºæ ‘å¯¹å§:
- åˆå§‹åŒ–æ ‡è®°
- å¦‚æœæ˜¯å¶å­ (åŒºé—´é•¿åº¦ç­‰äº 1)
  - æŠŠæ•°ç»„å…ƒç´ æ”¾è¿›å¶å­é‡Œ
  - å®Œæˆå»ºæ ‘
- å»ºå·¦å­æ ‘
- å»º~~æŸšå­æ ‘~~å³å­æ ‘
- è®¾ç½®å½“å‰èŠ‚ç‚¹çš„åŒºé—´å’Œæ˜¯ä¸¤ä¸ªå­åŒºé—´çš„åŒºé—´å’Œ

çœ‹å§éå¸¸å¥½çš„ä»£ç :
```cpp
void init(int u, int ul, int ur) {
  // tag[u]=0;  // tagä½œä¸ºå…¨å±€æ•°ç»„å·²ç»åˆå§‹åŒ–ä¸º 0
  if (ul+1==ur) {
    sum[u]=a[ul];
    return;
  }
  // æœ‰äº›åœ°æ–¹çš„å†™æ³•æ˜¯ ul+ur>>1, ä¸‹é¢è¿™æ ·å†™å¯ä»¥é¿å…ä¸¤ä¸ªæ­£æ•°åŠ æ—¶æº¢å‡º
  int um=ul+(ur-ul>>1); // [ul, ur) -> [ul, um) + [um, ur)
  // u*2+1 å·¦å­ç»“ç‚¹, u*2+2 å³å­ç»“ç‚¹
  init(u*2+1, ul, um);
  init(u*2+2, um, ur);
  sum[u]=sum[u*2+1]+sum[u*2+2];
}
```
æœ‰äººè¦è¯´: â€œè¿™ä¸æ˜¯è¦ `pushup` å—?â€ä½†æ˜¯å…ˆåˆ«æ€¥æˆ‘ä»¬å…ˆå‡è®¾æ²¡å†™è¿‡çº¿æ®µæ ‘çš„åŒå­¦ä¸çŸ¥é“ä»€ä¹ˆæ˜¯ `pushup`.

ç„¶åæˆ‘ä»¬æ¥å†™åŒºé—´åŠ . å¦‚æœè¦æŸ¥æ‰¾çš„åŒºé—´ `[lf,rg)` ä¸æ˜¯æŸä¸ªèŠ‚ç‚¹çš„ç®¡ç†åŒºé—´çš„è¯, çº¿æ®µæ ‘å°±æŠŠå®ƒåˆ‡å¼€è®©å·¦å³å­æ ‘åˆ†åˆ«å¤„ç†. æ¯”å¦‚è¯´æ ·ä¾‹ç»™çš„åºåˆ—å»ºå‡ºäº†è¿™ä¸ªæ ‘:
```
è¾“å…¥:[1 5 4 2 3]  èŠ‚ç‚¹çš„æ„æ€: (u sum[u])[ul,ur)

                 (0 15)[0,5)
                 /          \
       (1 6)[0,2)          (2 9)[2,5)
        /      \            /     \
(3 1)[0,1) (4 5)[1,2) (5 4)[2,3) (6 5)[3,5)
                                   /    \
                           (13 2)[3,4) (14 3)[4,5)
```
è¦ç»™ [0,4) åŠ ä¸ŠæŸä¸ªæ•°, çº¿æ®µæ ‘æŠŠå®ƒæ‹†æˆ $[0,2)\cup[2,3)\cup[3,4)$, å¯¹åº” 1ã€5ã€13å·èŠ‚ç‚¹. æŒ‰ç€è¿™ä¸ªæ€è·¯å¯ä»¥çŸ¥é“åŒºé—´åŠ çš„ä»£ç åº”è¯¥æœ‰è¿™äº›æ­¥éª¤:
- å¦‚æœä¿®æ”¹åŒºé—´ç­‰äºå½“å‰èŠ‚ç‚¹çš„ç®¡ç†åŒºåŸŸ
  - æ‰“ä¸Šæ‡’æƒ°æ ‡è®°
  - é€€å‡ºå‡½æ•°
- æŠŠå½“å‰åŒºé—´åˆ†æˆä¸¤åŠ
- æ›´æ–°å·¦åŠè¾¹åŒºé—´
- æ›´æ–°å³åŠè¾¹åŒºé—´

å¾ˆåˆç†çš„é€’å½’, ä¸æ˜¯å—? å½“ç„¶ä¸æ˜¯.
- æ‡’æƒ°æ ‡è®°åªæ˜¯ç”¨æ¥é¿å…å­æ ‘å¤§é‡ä¿®æ”¹, è€Œè¦ä¿è¯è¿™ä¸ªèŠ‚ç‚¹è®°å½•çš„åŒºé—´å’Œå¿…é¡»ç­‰äºçœŸå®çš„åŒºé—´å’Œ, æ‰€ä»¥å®ƒè‡ªå·±çš„ `sum` ä¹Ÿè¦æ›´æ–°.
- æŒ‰ç…§æ‡’æƒ°æ ‡è®°çš„æ„æ€, å¶èŠ‚ç‚¹ä¸åº”è¯¥æœ‰æ‡’æƒ°æ ‡è®°. æ‰“æ ‡è®°å‰è¦å…ˆåˆ¤æ–­æ˜¯ä¸æ˜¯å¶èŠ‚ç‚¹, å¯ä»¥é€šè¿‡ç®¡ç†åŒºé—´é•¿åº¦æ˜¯ä¸æ˜¯1æ¥æ£€æµ‹.
- å¯¹äºæŸä¸ªèŠ‚ç‚¹, å¦‚æœå®ƒç®¡ç†çš„åŒºé—´ä¸ç”¨æ•´ä¸ªä¿®æ”¹, æŒ‰ä¸Šé¢çš„æµç¨‹å®ƒå¹¶ä¸ä¼šæ›´æ–°. ä½†æ˜¯æˆ‘ä»¬å¸Œæœ›å³ä½¿æŸä¸ªå­æ ‘æ›´æ–°äº†, è¿™ä¸ªèŠ‚ç‚¹ä¿å­˜çš„åŒºé—´å’Œä¹Ÿä¼šæ›´æ–°.

æ ¹æ®ä¸Šé¢æ‰åˆ°çš„è™«, åŒºé—´åŠ æ›´å®Œæ•´çš„æµç¨‹å¦‚ä¸‹(`[]`è¡¨ç¤ºå¢åŠ çš„éƒ¨åˆ†):
- å¦‚æœä¿®æ”¹åŒºé—´ç­‰äºå½“å‰èŠ‚ç‚¹çš„ç®¡ç†åŒºåŸŸ
  - \[åŒºé—´å’Œ `sum` å¢åŠ ä¿®æ”¹çš„å€¼Ã—åŒºé—´é•¿åº¦\]
  - \[å¦‚æœä¸æ˜¯å¶å­\]
    - æ‰“ä¸Šæ‡’æƒ°æ ‡è®°
  - é€€å‡ºå‡½æ•°
- æŠŠå½“å‰åŒºé—´åˆ†æˆä¸¤åŠ
- åˆ†åˆ«æ›´æ–°ä¸¤åŠè¾¹åŒºé—´
- \[æ›´æ–°å½“å‰èŠ‚ç‚¹çš„åŒºé—´å’Œ\]

æ³¨æ„åˆ°è¿™é‡Œâ€œæ›´æ–°å½“å‰èŠ‚ç‚¹çš„åŒºé—´å’Œâ€å’Œå»ºæ ‘æ—¶â€œè®¾ç½®å½“å‰èŠ‚ç‚¹çš„åŒºé—´å’Œæ˜¯ä¸¤ä¸ªå­åŒºé—´çš„åŒºé—´å’Œâ€æ˜¯åŒä¸€ä¸ªæ“ä½œ, æˆ‘ä»¬æŠŠè¿™ä¸¤ä¸ªæµç¨‹åˆå¹¶èµ·æ¥(å¦å¤–ä¸€ä¸ªç†ç”±æ˜¯, åœ¨æŸäº›çº¿æ®µæ ‘é¢˜é‡Œ, åˆå¹¶ä¸¤ä¸ªåŒºé—´ä¸åªæ˜¯ä¸€ä¸ªåŠ å·é‚£ä¹ˆç®€å•):
```cpp
void push_up(int u) { sum[u]=sum[u*2+1]+sum[u*2+2]; }
```

çœ‹èµ·æ¥æˆ‘å°±è¦å†™æ¨¡æ¿äº†, ä½†æ˜¯è¿™æ ·ä¿®æ”¹ååˆæœ‰äº†æ–°çš„é—®é¢˜. å¦‚æœå½“å‰çš„æ‡’æƒ°æ ‡è®°æ²¡æœ‰ä¸‹æ”¾ (å°±æ˜¯å­ç»“ç‚¹å¯¹åº”çš„åŒºé—´å’Œè¿˜è¦åŠ ä¸Šæ‡’æƒ°æ ‡è®°), æœ€åé¢ `pushup` æ—¶åˆç®€å•åœ°ç”¨å­ç»“ç‚¹å’Œæ¥è®¾ç½®åŒºé—´å’Œ, é‚£ä¹ˆå°±æ˜¯æŠŠä¸¤ä¸ªä¸çœŸå®çš„ç­”æ¡ˆåˆå¹¶æˆäº†æ–°çš„ç­”æ¡ˆ, è¿™æ ·ä¸æ€»èƒ½å¾—åˆ°æ­£ç¡®çš„å’Œ.
- å¦‚æœä¿®æ”¹åŒºé—´ç­‰äºå½“å‰èŠ‚ç‚¹çš„ç®¡ç†åŒºåŸŸ
  - åŒºé—´å’Œå¢åŠ ä¿®æ”¹çš„å€¼Ã—åŒºé—´é•¿åº¦
  - å¦‚æœä¸æ˜¯å¶å­
    - æ‰“ä¸Šæ‡’æƒ°æ ‡è®°
  - é€€å‡ºå‡½æ•°
- \[å¦‚æœå½“å‰èŠ‚ç‚¹æœ‰æ‡’æƒ°æ ‡è®°\]
  - \[æŠŠæ ‡è®°ä¸‹æ”¾åˆ°å·¦èŠ‚ç‚¹\]
  - \[æŠŠæ ‡è®°ä¸‹æ”¾åˆ°å³èŠ‚ç‚¹\]
  - \[æ¸…ç©ºæ‡’æƒ°æ ‡è®°\]
- æŠŠå½“å‰åŒºé—´åˆ†æˆä¸¤åŠ
- åˆ†åˆ«æ›´æ–°ä¸¤åŠè¾¹åŒºé—´
- \[`push_up`\]æ›´æ–°å½“å‰èŠ‚ç‚¹çš„åŒºé—´å’Œ

å¦‚æœä½ å°è¯•å®ç°è¿™ä¸ªæµç¨‹, ä½ ä¼šå‘ç°è¿™é‡Œâ€œæ ‡è®°ä¸‹æ”¾åˆ°èŠ‚ç‚¹â€æ—¶çš„æ“ä½œå’Œâ€œå¦‚æœä¿®æ”¹åŒºé—´ç­‰äºå½“å‰èŠ‚ç‚¹çš„ç®¡ç†åŒºåŸŸâ€é‡Œçš„æ“ä½œç›¸åŒ, æ‰€ä»¥æˆ‘æŠŠå®ƒä»¬åˆå¹¶åˆ°ä¸€ä¸ªå‡½æ•°é‡Œ:
```cpp
void node_add(ll k, int u, int ul, int ur) {
  sum[u] += k*(ur-ul);        // åŒºé—´å’Œå¢åŠ ä¿®æ”¹çš„å€¼Ã—åŒºé—´é•¿åº¦
  if (ul+1!=ur) tag[u] += k;  // å¦‚æœä¸æ˜¯å¶å­ æ‰“ä¸Šæ‡’æƒ°æ ‡è®°
}
```
> è™½ç„¶çº¿æ®µæ ‘é‡Œä¼šä»å¤–éƒ¨è°ƒç”¨çš„å‡½æ•°åªæœ‰ä¸‰ä¸ª, ç„¶è€Œå®ç°é‡Œå´ä¼šå¤šå‡ºå¦å¤–ä¸‰ä¸ªå‡½æ•°. å½“å†™è¿™ç§å¾ˆé•¿çš„ä»£ç æ—¶, æ€»è¦è®°å¾—æŠŠé‡å¤çš„ä»£ç åˆå¹¶æˆå‡½æ•°(ä½†æ˜¯è®°å¾—è¦åŒºåˆ†å¼€, å®ƒä»¬é‡å¤æ˜¯æ°å·§é‡å¤è¿˜æ˜¯å®ƒä»¬æœ¬èº«å°±æ˜¯è¦å®ç°ç›¸åŒçš„åŠŸèƒ½).
```cpp
// å†™é»˜è®¤å‚æ•°çš„è¯ä¸éœ€è¦æ¯æ¬¡å¤–éƒ¨è°ƒç”¨æ—¶éƒ½å¡«ä¸€æ¬¡ (0, 0, n) äº†
void range_add(int lf, int rg, ll k, int u=0, int ul=0, int ur=n) {
  if (lf==ul &&  rg==ur) {
    node_add(k, u, ul, ur);
    return;
  }
  int um=ul+(ur-ul>>1);
  if (tag[u]) {
    node_add(k, u*2+1, ul, um);
    node_add(k, u*2+2, um, ur);
    tag[u]=0;
  }
  if (lf<um) range_add(lf, std::min(rg, um), k, u*2+1, ul, um);
  if (um<rg) range_add(std::max(lf, um), rg, k, u*2+2, um, ur);
  push_up(u);
}
```
å¥½å•¦ç°åœ¨æˆ‘ä»¬æ¥å†™æ±‚åŒºé—´å’Œçš„ç¨‹åº. åˆ†æ²»æ€æƒ³å’ŒåŒºé—´ä¿®æ”¹çš„ä¸€æ ·. ç”±äºæ±‚åŒºé—´å’Œåªæ˜¯è®¿é—®çº¿æ®µæ ‘è€Œæ²¡æœ‰ä¿®æ”¹(ä¹Ÿè®¸ä½ ä¼šè§‰å¾—ä¸‹æ”¾æ ‡è®°ä¿®æ”¹äº†çº¿æ®µæ ‘çš„æ•°ç»„, å¯æ˜¯å·²ç»ä¿è¯äº†å¯¹äº`tag[u]`, `u` å’Œå®ƒä¸Šçº§çš„èŠ‚ç‚¹ä¿å­˜çš„åŒºé—´å’Œæ— å…³, æ‰€ä»¥ä¸‹æ”¾æ ‡è®°ä¸ä¼šæ”¹å˜ä¸Šçº§èŠ‚ç‚¹), æ— éœ€åœ¨æœ€åä¸€æ­¥å‘ä¸Šæ›´æ–°.
- å¦‚æœ\[æŸ¥è¯¢\]åŒºé—´ç­‰äºå½“å‰èŠ‚ç‚¹çš„ç®¡ç†åŒºåŸŸ
  - \[è¿”å›å½“å‰èŠ‚ç‚¹ä¿å­˜çš„åŒºé—´å’Œ\]
- å¦‚æœå½“å‰èŠ‚ç‚¹æœ‰æ‡’æƒ°æ ‡è®°
  - æŠŠæ ‡è®°ä¸‹æ”¾åˆ°å·¦èŠ‚ç‚¹
  - æŠŠæ ‡è®°ä¸‹æ”¾åˆ°å³èŠ‚ç‚¹
  - æ¸…ç©ºæ‡’æƒ°æ ‡è®°
- æŠŠå½“å‰åŒºé—´åˆ†æˆä¸¤åŠ
- åˆ†åˆ«\[è®¡ç®—\]ä¸¤åŠè¾¹åŒºé—´çš„åŒºé—´å’Œ
- \[è¿”å›ä¸¤åŠçš„å’Œ\]

ä½ çœ‹è¿™é‡Œåˆæœ‰é‡å¤çš„æ­¥éª¤äº†, é‚£æˆ‘ä»¬å†æå–å‡ºä¸€ä¸ª `push_down` å‡½æ•°:
```cpp
void push_down(int u, int ul, int ur) {
  int um=ul+(ur-ul>>1);
  node_add(tag[u], ul, um); // æŠŠæ ‡è®°ä¸‹æ”¾åˆ°å·¦èŠ‚ç‚¹
  node_add(tag[u], um, ur); // æŠŠæ ‡è®°ä¸‹æ”¾åˆ°å³èŠ‚ç‚¹
  tag[u]=0;                 // æ¸…ç©ºæ‡’æƒ°æ ‡è®°
}
```
æŠŠæŸ¥è¯¢åŒºé—´å’Œçš„æµç¨‹å†™æˆä»£ç æ˜¯è¿™ä¸ªæ ·å­
```cpp
ll get_sum(int lf, int rg, int u=0, int ul=0, int ur=n) {
  if (lf==ul && rg==ur) return sum[u];
  if (tag[u]) push_down(u, ul, ur);
  int um=ul+(ur-ul>>1); ll ret=0;
  if (lf<um) ret+=get_sum(lf, std::min(rg, um), u*2+1, ul, um);
  if (um<rg) ret+=get_sum(std::max(lf, um), rg, u*2+2, um, ur);
  return ret;
}
```
ğŸ†ğŸ†ğŸ†å¤ªå¥½äº†æ‰€æœ‰åŠŸèƒ½éƒ½å®Œæˆå•¦! æ¥æ€»ç»“ä»¥ä¸‹çº¿æ®µæ ‘æœ‰å“ªäº›å‡½æ•°:
- `void node_add(ll k, int u, int ul, int ur)`
  - å•ç‹¬æ›´æ–°æŸä¸ªèŠ‚ç‚¹, éå¶å­çš„è¯é€šè¿‡æ‡’æƒ°æ ‡è®°æ›´æ–°å­æ ‘.
- `void push_up(int u)`
  - å½“å­æ ‘é‡Œç»´æŠ¤çš„æŸä¸ªæ•°æ® (è¿™é“é¢˜é‡Œæ˜¯åŒºé—´å’Œ) æ›´æ–°åèŠ‚ç‚¹ `u` ä¹Ÿè¦é‡æ–°è®¡ç®—.
- `void push_down(int u, int ul, int ur)`
  - è¦è®¿é—®å­ç»“ç‚¹æ•°æ® (è¿™é“é¢˜é‡Œæ˜¯å­åŒºé—´å’Œ) å‰è®°å¾—ä¸‹æ”¾æ ‡è®°.
  - æ‡’æƒ°æ ‡è®°ä¸è¦å¤ªæ‡’, ä¸ç„¶ä¼š WA.
- `void init(int u, int ul, int ur)`
  - å»ºæ ‘. å¾ˆå¤šäººä¹Ÿå« `build`.
- `void range_add(int lf, int rg, ll k, int u=0, int ul=0, int ur=n)`
  - åŒºé—´ä¿®æ”¹ (è¿™é“é¢˜é‡Œæ˜¯åŒºé—´åŠ ), ç­‰ä¸‹æˆ‘ä¼šè§£é‡Šæ›´å¤šåŒºé—´æ“ä½œçš„ä»£ç æ€ä¹ˆå†™.
  - ç¤ºä¾‹ `range_add(2,5,3)` ä¸‹æ ‡åœ¨[2,5) or ä¸‹æ ‡ä¸º 2~4 or ç¬¬ 3~5 ä¸ªæ•°åŠ  3.
- `ll get_sum(int lf, int rg, int u=0, int ul=0, int ur=n)`
  - æ±‚åŒºé—´å’Œ. `get_sum(0, n)` è¿”å›æ•´ä¸ªåºåˆ—çš„å’Œ.

ğŸ™ğŸ¼ğŸ™ğŸ¼ğŸ™ğŸ¼å¸Œæœ›ä¸è¦æœ‰äººå†è¢«è°ƒè¯•ä¸€ä¸ªçº¿æ®µæ ‘çš„æ¿å­æµªè´¹æ•°å¤©æ—¶é—´äº†, åœ¨æ­¤é™„ä¸Šå®Œæ•´çº¿æ®µæ ‘æ¿å­+è°ƒè¯•å·¥å…·:
```cpp
/* * * * * * * * * * * * * * *
 * ç¥ç¦å†™æ³¨é‡Šçš„ oier éƒ½èƒ½ AC *
 * * * * * * * * * * * * * * */
#include <iostream>
using ll=long long;
const int N=1e5+3;
int n, t, a[N];         // tag å­æ ‘å°†è¦åŠ ä¸Šçš„å€¼; sum çš„åŒºé—´å’Œå·²ç»åŠ ä¸Šäº†tag
ll sum[N*4], tag[N*4];  // è®¿é—®åˆ° sum æ—¶è¦ä¿è¯ sum ç­‰äºå®é™…çš„åŒºé—´å’Œ
void node_add(ll k, int u, int ul, int ur) {
  sum[u] += k*(ur-ul);
  if (ul+1!=ur) tag[u] += k;  // ä¸è¦å¿˜äº†æ‡’æƒ°æ ‡è®°
}
void push_up(int u) {
  sum[u] = sum[u*2+1] + sum[u*2+2];
}
void push_down(int u, int ul, int ur) {
  int um=ul+(ur-ul>>1);
  node_add(tag[u], u*2+1, ul, um);  // æ³¨æ„æ˜¯node_addä¸åªæ˜¯æ·»åŠ 
  node_add(tag[u], u*2+2, um, ur);  // è¿˜æœ‰æ‡’æƒ°æ ‡è®°
  tag[u] = 0;
}
void init(int u, int ul, int ur) {
  if (ul+1==ur) { sum[u]=a[ul]; return; }
  int um=ul+(ur-ul>>1);
  init(u*2+1, ul, um), init(u*2+2, um, ur);
  push_up(u); // å­æ ‘æ›´æ–°ä¹‹åè®°å¾—æ›´æ–°ä¸Šçº§èŠ‚ç‚¹
}
void range_add(int lf, int rg, ll k, int u=0, int ul=0, int ur=n) {
  // è¿™è¡Œä»£ç èƒ½è®©'#'å·å¤¹ä½çš„éƒ¨åˆ†æäº¤åˆ° OJ ä¸Šæ—¶è‡ªåŠ¨åˆ é™¤
#ifndef ONLINE_JUDGE
  if (!u) fprintf(stderr, "### range_add(%d %d %lld)\n", lf, rg, k);
  else fprintf(stderr, "range_add(%2d %2d %2d %2d %2d)\n", lf, rg, u, ul, ur);
#endif
  if (lf==ul && rg==ur) { node_add(k, u, ul, ur); return; }
  if (tag[u]) push_down(u, ul, ur); // æ‡’æƒ°æ ‡è®°ä¸è¦å¤ªæ‡’è®°å¾—åŠæ—¶æ›´æ–°
  int um=ul+(ur-ul>>1);
  // è®°å¾—ç”¨ min max æŠŠå¤šä½™çš„åŒºé—´æˆªæ‰ä¸ç„¶ä¼šæ— é™é€’å½’ (RE/TLE/æ®µé”™è¯¯)
  // å½“ç„¶ä¹Ÿå¯ä»¥ä¸æˆª, æŠŠé€’å½’è¾¹ç•Œä¿®æ”¹æˆâ€œæŸ¥è¯¢åŒºé—´åŒ…å«åœ¨èŠ‚ç‚¹ç®¡ç†åŒºé—´é‡Œâ€
  if (lf<um) range_add(lf, std::min(rg, um), k, u*2+1, ul, um);
  if (um<rg) range_add(std::max(lf, um), rg, k, u*2+2, um, ur);
  push_up(u);
}
ll get_sum(int lf, int rg, int u=0, int ul=0, int ur=n) {
#ifndef ONLINE_JUDGE
  if (!u) fprintf(stderr, "### get_sum(%d %d)\n", lf, rg);
  else fprintf(stderr, "get_sum(%2d %2d %2d %2d %2d)\n", lf, rg, u, ul, ur);
#endif
  if (lf==ul && rg==ur) return sum[u];
  if (tag[u]) push_down(u, ul, ur);
  // æ³¨æ„è¦å¼€ long long æ—¶è¿™ä¸¤ä¸ªå˜é‡ä¸è¦æ”¾åœ¨ä¸€èµ·å£°æ˜äº†
  int um=ul+(ur-ul>>1); ll ret=0;
  if (lf<um) ret += get_sum(lf, std::min(rg, um), u*2+1, ul, um);
  if (um<rg) ret += get_sum(std::max(lf, um), rg, u*2+2, um, ur);
  return ret; // è¿™ä¸¤ä¸ªå‡½æ•°é•¿å¾—å¾ˆåƒå¤åˆ¶ç²˜è´´åè®°å¾—ä¿®æ”¹
}
// =====DEBUG=====
void print_list(int step=1) {  // å¯¹è¿ç»­ step ä¸ªæ•°å­—æ±‚å’Œ
  for (int i=0; i+step<=n; i++)
    std::cout << get_sum(i, i+step) << ' ';
  std::cout << '\n';
}
void print_tree(int u=0, int ul=0, int ur=n) {
  if (!u) std::cerr << "====print_tree.begin====\n"
    "type id [ul ur) sum tag\n";
  std::fprintf(stderr, "%s %2d [%-2d %2d) %3lld %lld\n",
      (ul+1==ur ? "lf  ":"  nd"), u, ul, ur, sum[u], tag[u]);
  if (ul+1==ur) return;
  int um=ul+(ur-ul>>1);
  print_tree(u*2+1, ul, um), print_tree(u*2+2, um, ur);
  if (!u) std::cerr << "----print_tree.end------\n";
}
// -----DEBUG-----
// main ç•¥å»
```
## ä¸ä»…èƒ½åŠ è¿˜èƒ½ä¹˜çš„çº¿æ®µæ ‘
ç›®å‰ä¸ºæ­¢æˆ‘ä»¬çš„çº¿æ®µæ ‘è¿˜åªæ”¯æŒåŠ æ³•. é‚£å¦‚æœå¼•å…¥ä¹˜æ³•å‘¢?
> [Luogu P3373](https://www.luogu.com.cn/problem/P3373) çº¿æ®µæ ‘ II <br/>
> ç»´æŠ¤ä¸€ä¸ªåºåˆ—, å…è®¸åŒºé—´åŠ ã€åŒºé—´ä¹˜ã€æ±‚åŒºé—´æ¨¡ $M$ æ„ä¹‰ä¸‹çš„å’Œ.<br/>
> æ“ä½œæ•°å’Œåºåˆ—é•¿åº¦ä¸è¶…è¿‡ 1e5, $M=571373=11\times127\times409$.

As we know(æ­£å¦‚æˆ‘ä»¬çŸ¥é“çš„), æ‡’æƒ°æ ‡è®°ç”¨æ¥å¿«é€Ÿä¿®æ”¹, åŒºé—´å’Œç”¨æ¥å¿«é€ŸæŸ¥è¯¢. æ‡’æƒ°æ ‡è®°å‘ä¸‹èµ°(`push_down`), åŒºé—´å’Œå‘ä¸Šæ›´æ–°(`push_up`). è¿™é‡Œå¢åŠ çš„æ˜¯ä¿®æ”¹æ“ä½œ, é‚£æˆ‘ä»¬å½“ç„¶ä¹Ÿç”¨ä¸¤ä¸ªæ‡’æƒ°æ ‡è®°å¿«é€Ÿä¿®æ”¹. 
```cpp
ll mul[N], plu[N];  // mul è¡¨ç¤ºå°†è¦ä¹˜ä¸Šçš„å€¼, plu è¡¨ç¤ºå°†è¦ä¹˜ä¸Šçš„å€¼
```
å¦‚æœä½ å»ç¿»é¢˜è§£, ä½ ä¼šå‘ç°å‡ ä¹å¤§å®¶éƒ½åœ¨è®¨è®ºå…ˆä¹˜ååŠ è¿˜æ˜¯å…ˆåŠ åä¹˜çš„äº‹æƒ…. è¿™æ˜¯ä»€ä¹ˆæ„æ€å•Š? Recall that(å›é¡¾) æ‡’æƒ°æ ‡è®°çš„æ„æ€æ˜¯å­æ ‘å°†è¦è¿›è¡Œçš„æ“ä½œ. é‚£å‡è®¾æŸä¸ªå¶å­ç»“ç‚¹çš„æ•°å­—æ˜¯ sum, å®ƒå¯¹åº”çš„æ‡’æƒ°æ ‡è®°æ˜¯ plu å’Œ mul, é‚£å®ƒå®é™…çš„å€¼æ˜¯ sum Ã— plu + mul è¿˜æ˜¯ (sum + mul) Ã— plu? æˆ‘ä»¬å…ˆè¯´å‰è€…, å³å…ˆä¹˜ååŠ .

å…ˆä¹˜ååŠ çš„å¦å¤–ä¸€ä¸ªæ„æ€æ˜¯, ä¸¤æ¬¡æŸ¥è¯¢é—´æ€»æ˜¯ä¼šåŠ ä¸€ä¸‹ä¹˜ä¸€ä¸‹åˆåŠ åŠ ä¹˜ä¹˜çš„, è€Œæˆ‘ä»¬æƒ³è¦æŠŠæ‰€æœ‰åŠ æ³•åé¢çš„ä¹˜æ³•æ“ä½œ, ç­‰æ•ˆæˆåœ¨åŠ æ³•å‰é¢ä¹˜æ³•æ“ä½œ. å…·ä½“è€Œè¨€, å‡è®¾æŸä¸ªå¶å­ç»“ç‚¹çš„æ•°å­—æ˜¯ sum, å®ƒå¯¹åº”çš„æ‡’æƒ°æ ‡è®°æ˜¯ plu å’Œ mul, ç„¶åç°åœ¨æˆ‘ä»¬æ¥äº†ä¸€ç»„æ–°çš„æ“ä½œ: ä¹˜ $k$ åŠ  $b$. é‚£å¦‚ä½•æŠŠæ–°çš„æ“ä½œåˆå¹¶åˆ°æ—§çš„æ‡’æƒ°æ ‡è®°å‘¢? æŒ‰ç…§ä¸€äº›è¿ç®—å¾‹å¯ä»¥å‘ç°:
$$\begin{aligned}
&(\mathrm{sum}\times\mathrm{mul}+\mathrm{plu})\times k+b\\
={}& \mathrm{sum}\times\mathrm{mul}\times k+(\mathrm{plu}\times k+b)
\end{aligned}$$
å¯¹äºåŠ çš„æ“ä½œ, å¯ä»¥ä»¤$k=1$; å¯¹äºä¹˜æ³•æ“ä½œ, å¯ä»¥ä»¤ $b=0$. è¿™å°±æ˜¯ `node_update` è¦å˜åŒ–çš„åœ°æ–¹.
```cpp
// åœ¨ä¸Šä¸€é¢˜è¿™ä¸ªå‡½æ•°å« node_add
void node_update(ll k, ll b, int u, int ul, int ur) {
  sum[u] = (sum[u]*k+b*(ur-ul)) % m;
  if (ul+1==ur) return;
  mul[u] = mul[u]*k % m;      // (x*mul+plu)*k+b = x*mul*k + plu*k+b
  plu[u] = (plu[u]*k+b) % m;  // mul <- mul*k; plu <- plu*k+b
}
```
è¿™é“é¢˜æœ€éš¾æƒ³é€šçš„å°±æ˜¯è¿™é‡Œäº†. å…¶å®ƒä¿®æ”¹éƒ½æ˜¯ç»†ææœ«èŠ‚, è§ä¸‹é¢çš„æ³¨é‡Š.
```cpp
// è™½ç„¶å¹¸è¿å€¼å®ˆæ’ ä½†æˆ‘è¿˜æ˜¯ç›¸ä¿¡å¤šå†™ç‚¹æ³¨é‡Šè‚¯å®šä¼šè·å¾—é¢å¤–å¹¸è¿ç‚¹
const int N=1e5+5;
using ll=long long;
int n, m, t, a[N];
ll sum[N*4], mul[N*4], plu[N*4];
// ç”±äºä¹˜æ³•å’ŒåŠ æ³•å–æ¨¡è¿ç®—æ¥è¯´éƒ½æ˜¯è‡ªç”±çš„ ä¸ºäº†é˜²æ­¢æº¢å‡º ç®—ä¸€æ­¥æ¨¡ä¸€æ­¥
void push_up(int u) { sum[u] = (sum[u*2+1]+sum[u*2+2]) % m; }
void init(int u, int ul, int ur) {
  mul[u]=1; // mul ä¸æ˜¯åˆå§‹åŒ–ä¸º 0 ä¸ºäº†æ‰¾è¿™ä¸ª bug è°ƒäº†ä¸€å¤©
  if (ul+1==ur) { sum[u]=a[ul]; return; }
  int um=ul+(ur-ul>>1);
  init(u*2+1, ul, um), init(u*2+2, um, ur);
  push_up(u);
}
void node_update(ll k, ll b, int u, int ul, int ur) {
  sum[u]=(sum[u]*k+b*(ur-ul)) % m;
  if (ul+1==ur) return;
  mul[u] = mul[u]*k % m;      // (x*mul+plu)*k+b = x*mul*k + (plu*k+b)
  plu[u] = (plu[u]*k+b) % m;  // mul <- mul*k; plu <- plu*k+b
}
void push_down(int u, int ul, int ur) {
  int um=ul+(ur-ul>>1);
  node_update(mul[u], plu[u], u*2+1, ul, um);
  node_update(mul[u], plu[u], u*2+2, um, ur);
  mul[u]=1, plu[u]=0; // åŒç† mul åˆå§‹åŒ–ä¸º 1
}
void range_update(int lf, int rg, ll k, ll b,
    int u=0, int ul=0, int ur=n) {
  // ä¸¤ç§æ“ä½œ: åŠ æ³•æ—¶ k=1; ä¹˜æ³•æ—¶ b=0
  if (lf==ul&&rg==ur) {
    node_update(k, b, u, ul, ur); // å‚æ•°é¡ºåºä¸èƒ½å†™é”™
    return;
  } // æ£€æŸ¥æ ‡è®°æ—¶ä¸è¦å¼„å mul å’Œ plu
  if (mul[u]!=1 || plu[u]) push_down(u, ul, ur);
  int um=ul+(ur-ul>>1);
  if (lf<um) range_update(lf, std::min(rg, um), k, b, u*2+1, ul, um);
  if (um<rg) range_update(std::max(lf, um), rg, k, b, u*2+2, um, ur);
  push_up(u);
}
ll get_sum(int lf, int rg, int u=0, int ul=0, int ur=n) {
  if (lf==ul && rg==ur) return sum[u];
  if (mul[u]!=1 || plu[u]) push_down(u, ul, ur);
  int um=ul+(ur-ul>>1); ll ret=0; // è¯¥å¼€ long long è®°å¾—å¼€.
  if (lf<um) ret += get_sum(lf, std::min(rg, um), u*2+1, ul, um);
  if (um<rg) ret += get_sum(std::max(lf, um), rg, u*2+2, um, ur);
  return ret % m;
}
// main ç•¥å»
```
ç„¶åæ¥è¯´å…ˆåŠ åä¹˜ä¼šå‘ç”Ÿä»€ä¹ˆ. è¿˜æ˜¯åŒæ ·çš„æ€è·¯:
$$\begin{aligned}
&[(\mathrm{sum}+\mathrm{plu})\times\mathrm{mul}+b]\times k\\
={}&[(\mathrm{sum}+\mathrm{plu}+b\times\mathrm{mul}^{-1})\times\mathrm{mul}\times k\\
\end{aligned}$$
ä½ ä¼šå‘ç°è¿™è¦(yÃ o)æ±‚ä¹˜æ³•é€†å…ƒ. å¾ˆé—æ†¾æ— è®ºæ˜¯æ•°æ®çš„æ¨¡æ•° 571373 è¿˜æ˜¯æ ·ä¾‹ 38 éƒ½æ˜¯ä¸ªåˆæ•°, å®ƒä»¬çš„å‰©ä½™ç³»(é™¤ä»¥ $M$ å¯èƒ½çš„ä½™æ•°)é‡Œæ€»æœ‰äº›æ•°å’Œ $M$ ä¸äº’ç´ (ä¸äº’è´¨/æœ€å¤§å…¬çº¦æ•°æ¯”1å¤§), æ²¡æœ‰ä¹˜æ³•é€†å…ƒ, è¿™ç§åšæ³•è¡Œä¸é€š.
